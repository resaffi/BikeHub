require 'rubygems'
require 'json'
require "net/http"
require "uri"
require 'sinatra'
#require 'sinatra/reloader'
require 'redis'
require_relative 'redis_helper'
require_relative 'helper'
require_relative 'geo_node'
require 'addressable/uri'
$r = Redis.new(url: ENV["REDIS_URL"])
$redis_object= RedisHelper.new($r)
$url_bikes = "http://dadosabertos.rio.rj.gov.br/apiTransporte/apresentacao/rest/index.cfm/estacoesBikeRio"

response = Helper.request_to_response($url_bikes)
data =  JSON.parse(response)['DATA']
$redis_object.add_geodata_from_api(data)
get '/' do
    user_address = params[:address].to_s
    street = user_address.gsub(/\s+/, "%20")
    url_map = "http://nominatim.openstreetmap.org/search?street=#{street}&city=rio+de+janeiro&format=json"
    response = Helper.request_to_response(url_map)
    json_parsed = JSON.parse(response)[0]
    lat =  json_parsed["lat"] if defined?(json_parsed["lat"])
    long = json_parsed["lon"] if defined?(json_parsed["lon"])
    nearest =  $redis_object.client.georadius "bikes",lat,long,500000,"m","WITHCOORD","WITHDIST","COUNT",5,"ASC"

    erb :index, :locals => {'user_address'=> user_address,'long'=>long, 'lat' => lat, 'nearest' => nearest}

end

